<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>M&M Agro Farms â€“ Order Form</title>
  <style>
    body {
      font-family: Arial; background: #f0fff0;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0;
    }
    .form-container {
      background: #d4edda; padding: 20px; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 90%; max-width: 460px;
    }
    .notice {
      background: #fff3cd; padding: 10px; margin-bottom: 10px;
      border: 1px solid #ffeeba; border-radius: 6px; color: #856404;
    }
    h2 { text-align: center; color: #155724; margin-bottom: 20px; }
    label { font-weight: bold; color: #155724; margin-top: 10px; display: block; }
    input, select, textarea {
      width: 100%; padding: 8px; margin-top: 5px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
    }
    button {
      margin-top: 16px; padding: 10px; width: 100%;
      background: #28a745; color: white; font-size: 16px;
      border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background: #218838; }
    .total-box {
      margin-top: 10px; font-weight: bold; font-size: 16px; color: #000;
    }
    .message {
      margin-top: 20px; color: #155724; font-weight: bold;
    }
  </style>
</head>
<body>

<div class="form-container">
  <div class="notice" id="noticeBox">ğŸ”„ Loading rates and info...</div>
  <h2>Place Your Order</h2>

  <form id="orderForm">
    <label for="product">Select Product</label>
    <select id="product" required>
      <option value="" disabled selected>-- Choose --</option>
      <option value="mutton">Mutton</option>
      <option value="chicken">Dressed Desi Chicken</option>
      <option value="egg">Desi Eggs</option>
    </select>

    <label for="quantity">Quantity (Kg / Nos)</label>
    <input type="number" id="quantity" required min="0.5" step="0.5">

    <label for="name">Name</label>
    <input type="text" id="name" required oninput="this.value = this.value.toUpperCase()">

    <label for="mobile">Mobile No</label>
    <input type="tel" id="mobile" maxlength="10" pattern="\d{10}" required>

    <label for="address">Delivery Address</label>
    <textarea id="address" required></textarea>

    <label for="datetime">Preferred Date & Time</label>
    <input type="datetime-local" id="datetime" required>

    <label for="notes">Additional Notes</label>
    <textarea id="notes" placeholder="e.g. Call before delivery..."></textarea>

    <div class="total-box">Total: â‚¹<span id="total">0.00</span></div>

    <button type="submit">Submit Order</button>
  </form>

  <div class="message" id="responseMsg"></div>
</div>

<script>
  const scriptURL = 'YOUR_DEPLOYED_SCRIPT_URL_HERE'; // <-- Replace with your Web App URL
  const ownerWhatsApp = "918688014021";

  let prices = { mutton: 850, chicken: 550, egg: 13 };
  let notice = "";
  let limits = { mutton: 100, chicken: 20 };
  let totals = { mutton: 0, chicken: 0 };

  async function loadSettings() {
    const res = await fetch(`${scriptURL}?action=getSettings`);
    const data = await res.json();
    prices = {
      mutton: parseFloat(data.mutton_price),
      chicken: parseFloat(data.chicken_price),
      egg: parseFloat(data.egg_price)
    };
    notice = data.customer_notice || "";
    document.getElementById("noticeBox").innerText =
      `ğŸ“¢ ${notice} \n Mutton â‚¹${prices.mutton}/kg, Chicken â‚¹${prices.chicken}/kg, Egg â‚¹${prices.egg}/each`;
  }

  async function loadTotals() {
    const res = await fetch(`${scriptURL}?action=getTotals`);
    totals = await res.json();
  }

  function updateTotal() {
    const product = document.getElementById("product").value;
    const qty = parseFloat(document.getElementById("quantity").value) || 0;
    const total = prices[product] * qty;
    document.getElementById("total").innerText = total.toFixed(2);
  }

  document.getElementById("product").addEventListener("change", updateTotal);
  document.getElementById("quantity").addEventListener("input", updateTotal);

  function isCutoffReached() {
    const now = new Date();
    const day = now.getDay(); // 6 = Saturday
    const hour = now.getHours();
    return (day === 6 && hour >= 21);
  }

  function generateOrderID() {
    return "MM" + Math.floor(100000 + Math.random() * 900000);
  }

  document.getElementById("orderForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    await loadTotals(); // Refresh live quantities

    const product = document.getElementById("product").value;
    const qty = parseFloat(document.getElementById("quantity").value);
    const name = document.getElementById("name").value.trim();
    const mobile = document.getElementById("mobile").value.trim();
    const address = document.getElementById("address").value.trim();
    const datetime = document.getElementById("datetime").value.trim();
    const notes = document.getElementById("notes").value.trim();
    const total = qty * prices[product];

    if (!product || !qty || !name || mobile.length !== 10 || !address || !datetime) {
      alert("Please fill all fields correctly.");
      return;
    }

    // Stock limit check
    if ((product === "mutton" && totals.mutton + qty > limits.mutton) ||
        (product === "chicken" && totals.chicken + qty > limits.chicken)) {
      document.getElementById("responseMsg").innerHTML = `âŒ Sorry, ${product} stock limit reached.`;
      return;
    }

    // Cutoff check
    if (isCutoffReached()) {
      document.getElementById("responseMsg").innerHTML = `â›” Orders closed after Saturday 9 PM.`;
      return;
    }

    const orderID = generateOrderID();
    const orderText =
`*ğŸŒ¿ M&M Agro Farms â€“ Order Confirmation*
ğŸ†” Order ID: ${orderID}
ğŸ‘¤ Name: ${name}
ğŸ“ Mobile: +91${mobile}
ğŸ– Product: ${product}
ğŸ“¦ Quantity: ${qty} ${product === 'egg' ? 'Nos' : 'Kg'}
ğŸ’° Total: â‚¹${total.toFixed(2)}
ğŸ“ Address: ${address}
ğŸ•“ Delivery: ${datetime}
ğŸ“ Notes: ${notes || 'None'}
âœ… Thank you for choosing us!`;

    // Save to Google Sheet
    await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify({ name, mobile, product, quantity: qty, total, address, datetime, notes })
    });

    // Send WhatsApp to customer
    window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(orderText)}`, "_blank");

    // Send alert to admin
    window.open(`https://wa.me/${ownerWhatsApp}?text=${encodeURIComponent("ğŸ“¢ New Order Received:\n" + orderText)}`, "_blank");

    document.getElementById("responseMsg").innerHTML = `âœ… Order placed successfully. Confirmation sent via WhatsApp.`;
    e.target.reset();
    document.getElementById("total").innerText = "0.00";
  });

  // Init
  loadSettings();
</script>

</body>
</html>
